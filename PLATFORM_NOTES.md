# Cross-Platform Compatibility Notes

This document describes platform-specific considerations for running Rockbox Database Manager on Windows, macOS, and Linux.

## Platform Support

- **Python**: 3.11+ required
- **wxPython**: 4.2+ (Phoenix) required
- **Supported OS**: Windows, macOS, Linux

## wxPython Phoenix Migration

This project has been updated to use **wxPython Phoenix** (4.x+), the modern version of wxPython. The following changes were made from the classic wxPython API:

### Event System
- **Old**: `wx.NewEventType()` and `wx.PyEventBinder()`
- **New**: `wx.lib.newevent.NewEvent()`

### Event Classes
- **Old**: `wx.PyCommandEvent`
- **New**: `wx.CommandEvent` (or use event classes from `wx.lib.newevent.NewEvent()`)

### File Dialogs (if used in future)
- **Old**: `wx.OPEN`, `wx.SAVE`
- **New**: `wx.FD_OPEN`, `wx.FD_SAVE`

### Cursors (if used in future)
- **Old**: `wx.StockCursor(wx.CURSOR_WAIT)`
- **New**: `wx.Cursor(wx.CURSOR_WAIT)`

### Note on wxFB_gui.py
The file `wxFB_gui.py` is auto-generated by wxFormBuilder. While it contains some patterns like `wx.EmptyString` that are legacy, they still work in Phoenix. If you need to regenerate this file:
1. Open `gui.fbp` in wxFormBuilder
2. Generate Python code
3. Manually verify compatibility with Phoenix

## Platform Support

## Installation Requirements by Platform

### All Platforms

```bash
# Install using uv (recommended)
uv sync

# Or using pip
pip install -r requirements.txt
```

### Linux

wxPython requires system development headers to build from source:

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install libgtk-3-dev libwebkit2gtk-4.0-dev
uv sync
```

**Fedora/RHEL/CentOS:**
```bash
sudo dnf install gtk3-devel webkit2gtk3-devel
uv sync
```

**Arch Linux:**
```bash
sudo pacman -S gtk3 webkit2gtk
uv sync
```

### macOS

> **Testing Status**: This application has been tested and verified working on:
> - macOS Sonoma 14.8.3 (23J220) - Intel Mac
> 
> Testing on Apple Silicon Macs and other macOS versions is in progress.

wxPython requires a **framework-enabled Python build** on macOS. The standard Python from Homebrew includes framework support.

**Setup Steps:**

1. **Install Homebrew Python 3.11** (if not already installed):
   ```bash
   brew install python@3.11
   ```

2. **Verify it's framework-enabled**:
   ```bash
   /usr/local/opt/python@3.11/bin/python3.11 -c "import sysconfig; print('Framework:', sysconfig.get_config_var('PYTHONFRAMEWORK'))"
   # Should output: Framework: Python
   ```

3. **Create venv with framework Python** (uv will use Homebrew Python):
   ```bash
   cd /path/to/rockbox-db-manager
   rm -rf .venv  # Remove old venv if it exists
   UV_PYTHON=/usr/local/opt/python@3.11/bin/python3.11 uv venv .venv
   uv pip install mutagen wxpython
   ```

4. **Run the GUI**:
   ```bash
   # Option 1: Use the launcher script
   ./launch_gui.sh
   
   # Option 2: Run directly
   .venv/bin/python gui.pyw
   
   # Option 3: From any directory
   cd /path/to/rockbox-db-manager && .venv/bin/python gui.pyw
   ```

**Why Framework Python is Required:**

macOS requires GUI applications to use a framework-enabled Python build. Regular Python builds (like those from python.org or some Homebrew configurations) may not work with wxPython. The error manifests as a silent failure where the GUI doesn't appear.

**Troubleshooting:**

If the GUI still doesn't appear after following the steps above:

1. **Verify your venv uses framework Python**:
   ```bash
   .venv/bin/python -c "import sysconfig; print(sysconfig.get_config_var('PYTHONFRAMEWORK'))"
   # Should output: Python
   ```

2. **Check if wxPython can create a test window**:
   ```bash
   .venv/bin/python -c "import wx; app=wx.App(); print('wxPython works!')"
   ```

3. **Look for error messages in the terminal** where you launched the GUI

**Note:** The `.python-version` file specifies Python 3.11. When using `uv`, you must explicitly tell it to use the Homebrew Python with the `UV_PYTHON` environment variable as shown above.

### Windows

No special requirements. wxPython wheels are available via PyPI:

```bash
uv sync
```

## Path Handling

### Rockbox Database Format

The Rockbox database format expects **Unix-style paths with forward slashes** (`/`) regardless of the host platform. This is because Rockbox runs on embedded devices (iPods, Sansa, etc.) that use Unix-style paths.

### Implementation

The code automatically:
1. Uses `os.path.join()` for all local file operations (cross-platform compatible)
2. Strips drive letters with `os.path.splitdrive()` for database paths
3. Converts platform separators to forward slashes for Rockbox format

Example:
```python
# Windows input: C:\Music\Artist\Album\song.mp3
# Database path: /Music/Artist/Album/song.mp3

# macOS/Linux input: /Volumes/iPod/Music/Artist/song.mp3  
# Database path: /Music/Artist/song.mp3
```

### Important Note

When adding music files to the database, ensure:
- File paths are accessible from your computer
- The music will be copied to your device in the same directory structure
- The database expects paths relative to the device root (without drive letters)

## Running the GUI

### macOS
```bash
# Easiest way - use the launcher script
cd /path/to/rockbox-db-manager
./launch_gui.sh

# Or run directly with venv Python
.venv/bin/python gui.pyw
```

**Important:** Do not use `uv run python gui.pyw` unless you've configured uv to use framework Python (see Installation section above).

### Windows
```bash
python gui.pyw
# or just double-click gui.pyw
```

### Linux
```bash
python gui.pyw
```

## Known Issues

### wxPython on Linux

- **Wayland**: Some features may not work perfectly under Wayland. If you experience issues, try running under X11:
  ```bash
  GDK_BACKEND=x11 python gui.pyw
  ```

- **HiDPI/Scaling**: If the GUI appears too small or too large:
  ```bash
  export GDK_SCALE=2  # or 1.5, etc.
  python gui.pyw
  ```

### macOS Ventura+ (13.0+)

If you see warnings about "NSWindow drag regions", these are harmless and can be ignored. They're caused by wxPython's interaction with modern macOS window management.

## Threading Note

The GUI uses `_thread` module (Python 3's renamed `thread` module) for background operations. This is a low-level threading interface. In future versions, this should be migrated to:
- `threading.Thread` for better exception handling
- `concurrent.futures` for more robust task management

## Testing

After installation, verify everything works:

```python
# Test command-line interface
python -c "from database import Database; print('CLI works!')"

# Test GUI (will open a window)
python gui.pyw
```

## Troubleshooting

### "No module named 'wx'"

**Linux**: Install system dependencies (see above), then reinstall wxPython
**macOS**: Try `pythonw` or ensure you're using a framework build
**Windows**: Should work out of the box; try reinstalling wxPython

### "Cannot find libgtk" (Linux)

Install the GTK development packages listed above for your distribution.

### GUI doesn't start on macOS

Use `pythonw gui.pyw` instead of `python gui.pyw`

### Path separators in database look wrong

This is expected! The database uses Unix-style paths (`/`) even on Windows. This is correct for Rockbox compatibility.
